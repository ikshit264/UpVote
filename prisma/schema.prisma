generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Plan {
  FREE
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
  INCOMPLETE
  ON_HOLD
}

model Company {
  id           String         @id @default(cuid())
  email        String         @unique
  passwordHash String? // Optional for OAuth users
  googleId     String?        @unique // For Google OAuth
  name         String
  createdAt    DateTime       @default(now())
  applications Application[]
  subscription Subscription?
  usageMetrics UsageMetrics[]
}

model Application {
  id        String     @id @default(cuid())
  companyId String
  company   Company    @relation(fields: [companyId], references: [id])
  name      String
  createdAt DateTime   @default(now())
  feedback  Feedback[]
  votes     Vote[]
}

model Feedback {
  id            String      @id @default(cuid())
  applicationId String
  application   Application @relation(fields: [applicationId], references: [id])
  userId        String // External user ID from parent app
  title         String
  description   String
  status        String      @default("Open")
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  votes         Vote[]
  reply         Reply?
  tags          Tag[]
}

model Vote {
  id            String      @id @default(cuid())
  applicationId String
  application   Application @relation(fields: [applicationId], references: [id])
  feedbackId    String
  feedback      Feedback    @relation(fields: [feedbackId], references: [id])
  userId        String // External user ID from parent app
  voteType      String // UPVOTE or DOWNVOTE
  createdAt     DateTime    @default(now())

  @@unique([applicationId, feedbackId, userId]) // One vote per user per feedback
}

model Reply {
  id         String   @id @default(cuid())
  feedbackId String   @unique
  feedback   Feedback @relation(fields: [feedbackId], references: [id])
  message    String
  createdAt  DateTime @default(now())
}

model Tag {
  id         String   @id @default(cuid())
  feedbackId String
  feedback   Feedback @relation(fields: [feedbackId], references: [id])
  name       String
}

model Subscription {
  id        String             @id @default(cuid())
  companyId String             @unique
  company   Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  plan      Plan               @default(FREE)
  status    SubscriptionStatus @default(ACTIVE)

  // DODO Payments fields
  dodoCustomerId     String? @unique
  dodoSubscriptionId String? @unique
  dodoProductId      String?

  // Billing cycle - subscription anniversary based
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  trialEnd           DateTime?
  cancelAtPeriodEnd  Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dodoCustomerId])
  @@index([dodoSubscriptionId])
}

model UsageMetrics {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Subscription anniversary month (e.g., if subscription starts on 15th, this is the 15th of each month)
  periodStart DateTime // Start of billing period
  periodEnd   DateTime // End of billing period

  // Usage counters
  projectCount  Int @default(0)
  feedbackCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, periodStart])
  @@index([periodStart])
  @@index([companyId])
}

model Support {
  id        String   @id @default(cuid())
  email     String
  message   String
  createdAt DateTime @default(now())
}
